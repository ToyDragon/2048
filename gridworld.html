<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Grid World</title>
    <style type="text/css">
      html, body, #content {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;

        overflow: hidden;
      }

      #content {
        display: flex;
        flex-direction: row;;
      }

      #editor { 
        display: inline-block;
        width: 640px;
        height: 100%;
        flex-grow: 0;
      }

      #result { 
        vertical-align: top;
        display: inline-block;
        margin-left: -4px;
        height: 100%;
        flex-grow: 1;
      }

      .logRow {
        background-color: #272822;
        color: white;
      }

      .logRow:nth-of-type(2n) {
        background-color: #474842;
      }

      .time {
        padding-right: 10px;
      }
      
      #log {
        position: absolute;
        bottom: 0;
        width: 100%;
        padding: 5px;
        background-color: #272822;
        height: 250px;
        overflow-y: scroll;
      }

      #boardContainer {
        width: 100%;
        height: calc(100% - 250px);
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        background-color: #474842;
      }

      #board {
        width: 500px;
        height: 500px;
        margin: auto;
        border: 2px solid black;
        border-radius: 5px;
        background-color: #ededed;
        position: relative;
      }
      
      .verticalBar {
        position: absolute;
        height: 100%;
        width: 1px;
        background-color: #474842;
      }

      .horizontalBar {
        position: absolute;
        width: 100%;
        height: 1px;
        background-color: #474842;
      }

      .actor {
        position: absolute;
        width: 56px;
        height: 56px;
        background-size: 100% 100%;
      }
    </style>
  </head>
  <body>
    <div id="content">
      <div id="editor">import gridworld

tickCount = 0
def tick():
    global tickCount
    tickCount += 1  
    if tickCount % 3 == 0:        
        # Turn the bug clockwise.
        gridworld.getBug().turnRight()

        # Show the new rotation.
        print("Direction: ", gridworld.getBug().direction)
    else:
        # Move the bug forward.
        gridworld.getBug().moveForward()

        # Show the new position.
        print("Position: ", gridworld.getBug().x, ", ", gridworld.getBug().y)
gridworld.onTick(tick)
</div>
      <div id="result">
        <div id="boardContainer">
          <div id="board"></div>
        </div>
        <div id="log"></div>
      </div>
    </div>
    <div id="frameHost" style="display: none"></div>
      
    <script src="https://pagecdn.io/lib/ace/1.4.12/ace.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/brython/3.9.0/brython.js" type="text/javascript"></script>
    <script>
      ace.config.set("basePath", "https://pagecdn.io/lib/ace/1.4.12/");
      var editor = ace.edit("editor");
      editor.setTheme("ace/theme/monokai");
      editor.session.setMode("ace/mode/python");

      var logDiv = document.querySelector("#log");
      function addLogLine(message) {
        var messageRow = document.createElement("div");
        messageRow.classList.add("logRow");

        var timeEle = document.createElement("span");
        timeEle.classList.add("time");
        timeEle.innerText = formatDate(new Date());
        messageRow.appendChild(timeEle);

        var msgEle = document.createElement("span");
        msgEle.classList.add("message");
        msgEle.innerText = message;
        messageRow.appendChild(msgEle);

        logDiv.appendChild(messageRow);
        logDiv.scrollTop = logDiv.scrollHeight - logDiv.clientHeight;
      }

      var gameRoot = document.querySelector("#board");
      var images = {
        "bug": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADoAAAA6CAYAAADhu0ooAAABhWlDQ1BJQ0MgcHJvZmlsZQAAKJF9kT1Iw0AYht+mSotUHNpBxCFD1cWCqIijVLEIFkpboVUHk0v/oElDkuLiKLgWHPxZrDq4OOvq4CoIgj8gbm5Oii5S4ndJoUWMdxz38N73vtx9BwjNKlPNnglA1SwjnYiLufyqGHhFkKYfYYxJzNSTmcUsPMfXPXx8v4vxLO+6P0e/UjAZ4BOJ55huWMQbxDObls55nzjCypJCfE48btAFiR+5Lrv8xrnksMAzI0Y2PU8cIRZLXSx3MSsbKvE0cVRRNcoXci4rnLc4q9U6a9+TvzBU0FYyXKc1jASWkEQKImTUUUEVFmK0a6SYSNN53MM/5PhT5JLJVQEjxwJqUCE5fvA/+N1bszg16SaF4kDvi21/jACBXaDVsO3vY9tunQD+Z+BK6/hrTWD2k/RGR4seAQPbwMV1R5P3gMsdYPBJlwzJkfy0hGIReD+jb8oD4Vugb83tW/scpw9Alnq1fAMcHAKjJcpe93h3sLtv/9a0+/cDTPJymHuCs7EAAAAGYktHRAD/AP8A/6C9p5MAAAAJcEhZcwAALiMAAC4jAXilP3YAAAAHdElNRQflCAgDFwPhVSjKAAAAGXRFWHRDb21tZW50AENyZWF0ZWQgd2l0aCBHSU1QV4EOFwAAAU1JREFUaN7t2rsBwjAMBFCfd2AW9mAaRmAa9mAWhjAlFcbm9CVSmQLrRXJQPmh2MT4ch8XicEaa5YEASJNcEASpng8CIVVzgjVw3B/vxS9ns9zghbTGwhNpiYU30goLTeQKcAMMT6goUhOLaEgtLCIiNbCIipTGQgKpAVwEQxpqWkWN6iILksUiE5LBdoW7D88Yu9CMyGnuYJDB9ujUhj+q5BTb20HiMFBqj2ayUZPRrZ1MM7+258+Dz8+ta41k16yLUbI9O1Qq6tG27NrVugUtaEELWtAo0MnM6Tnv0lAkKBiqdVmoR/sya3ap1ojctnTrWlaVXauzZ87zCrzTaSkuRhInU+z9qNY9KvOciK2oWQtL/qb4q32J6i4AYQVVw2ogJf4flx6cfUNvtKjL5zdbWMdtJj7xjIhArdFuRERqzrAjWl6H+aa+oiJpvADza2mjQtH41QAAAABJRU5ErkJggg==",
      }
      function onFrameMessage(msg) {
        if (msg.data.indexOf("gridworld__internal__command") === 0) {
          const command_and_data = msg.data.substr("gridworld__internal__command:".length);
          const command = command_and_data.substr(0, command_and_data.indexOf(":"));
          const data = command_and_data.substr(command.length + 1);
          if (command === "print") {
            addLogLine(data);
          }
          if (command === "update_actor") {
            var actorData = JSON.parse(data);
            actorsById[actorData.id] = actorData;
            if (!elesById[actorData.id]) {
              elesById[actorData.id] = document.createElement("div");
              elesById[actorData.id].classList.add("actor");
              elesById[actorData.id].style["backgroundImage"] = "url(" + images[actorData.img] + ")";
              gameRoot.appendChild(elesById[actorData.id]);
            }
            elesById[actorData.id].style.left = Math.floor(actorData.x / size * 100) + "%";
            elesById[actorData.id].style.top = Math.floor(actorData.y / size * 100) + "%";
            elesById[actorData.id].style.transform = "rotate(" + Math.floor(actorData.direction * 45) + "deg)";
          }
        }
      }
      
      var iframe = null;
      var frameHost = document.querySelector("#frameHost");
      var size = 9;
      
      var actorsById = {};
      var elesById = {};
      
      function initGame() {
        for (var c of gameRoot.children){
          c.remove();
        }
        for (let x = 0; x < size - 1; ++x) {
          var ele = document.createElement("div");
          ele.classList.add("verticalBar");
          ele.style.left = Math.floor(((x + 1) / size) * 100) + "%";
          gameRoot.appendChild(ele);

          ele = document.createElement("div");
          ele.classList.add("horizontalBar");
          ele.style.top = Math.floor(((x + 1) / size) * 100) + "%";
          gameRoot.appendChild(ele);
        }
        actorsById = {};
        elesById = {};
      }

      function formatDate(d) {
        var two = function(x) {
          var s = "" + x;
          return s.length === 1 ? "0" + s : s;
        }
        return two(d.getHours()) + ":" + two(d.getMinutes()) + ":" + two(d.getSeconds()) + "." + two(Math.floor(d.getMilliseconds() / 10));
      }

      var tickInterval = null;
      function runCode() {
        if (tickInterval) {
          clearInterval(tickInterval);
        }
        if (iframe !== null) {
          iframe.contentWindow.removeEventListener("message", onFrameMessage);
          iframe.remove();
          iframe = null;
        }
        iframe = document.createElement("iframe");
        iframe.src = "/gridworld_pyframe.html";
        frameHost.appendChild(iframe);
        setTimeout(function() {
          addLogLine("-- code updated");
          initGame();
          iframe.contentWindow.postMessage("gridworld__internal__script:" + editor.getValue());
          iframe.contentWindow.addEventListener("message", onFrameMessage);
          tickInterval = setInterval(function() {
            iframe.contentWindow.postMessage("gridworld__internal__tick");
          }, 500);
        }, 100);
      }
      runCode();

      window.addEventListener("keydown", function(event) {
        if (event.ctrlKey || event.metaKey) {
          if (String.fromCharCode(event.which).toLowerCase() === "s") {
            event.preventDefault();
            runCode();
          }
        }
      });
    </script>
  </body>
</html>